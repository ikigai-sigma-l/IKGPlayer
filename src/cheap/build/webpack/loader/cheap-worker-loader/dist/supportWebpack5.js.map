{"version":3,"file":"supportWebpack5.js","names":["_utils","require","runAsChild","loaderContext","workerContext","options","callback","compiler","error","entries","compilation","workerFilename","files","cache","getCache","cacheIdent","cacheETag","getLazyHashedEtag","assets","get","getCacheError","content","inline","_compilation","workerSource","source","replace","sourceMappingURLRegex","sourceURLWebpackRegex","workerCode","workerGenerator","workerCodeBuffer","Buffer","from","store","storeCacheError","Error","request"],"sourceRoot":"../../src/cheap/build/webpack/cheap-worker-loader/src","sources":["../src/supportWebpack5.js"],"sourcesContent":["import {\n  workerGenerator,\n  sourceMappingURLRegex,\n  sourceURLWebpackRegex,\n} from \"./utils\";\n\nexport default function runAsChild(\n  loaderContext,\n  workerContext,\n  options,\n  callback\n) { \n  workerContext.compiler.runAsChild((error, entries, compilation) => {\n    if (error) {\n      return callback(error);\n    }\n\n    if (entries[0]) {\n      const [workerFilename] = [...entries[0].files];\n      const cache = workerContext.compiler.getCache(\"worker-loader\");\n      const cacheIdent = workerFilename;\n      const cacheETag = cache.getLazyHashedEtag(\n        compilation.assets[workerFilename]\n      );\n\n      return cache.get(cacheIdent, cacheETag, (getCacheError, content) => {\n        if (getCacheError) {\n          return callback(getCacheError);\n        }\n\n        if (options.inline === \"no-fallback\") {\n          // eslint-disable-next-line no-underscore-dangle, no-param-reassign\n          delete loaderContext._compilation.assets[workerFilename];\n\n          // TODO improve this, we should store generated source maps files for file in `assetInfo`\n          // eslint-disable-next-line no-underscore-dangle\n          if (loaderContext._compilation.assets[`${workerFilename}.map`]) {\n            // eslint-disable-next-line no-underscore-dangle, no-param-reassign\n            delete loaderContext._compilation.assets[`${workerFilename}.map`];\n          }\n        }\n\n        if (content) {\n          return callback(null, content);\n        }\n\n        let workerSource = compilation.assets[workerFilename].source();\n\n        if (options.inline === \"no-fallback\") {\n          // Remove `/* sourceMappingURL=url */` comment\n          workerSource = workerSource.replace(sourceMappingURLRegex, \"\");\n\n          // Remove `//# sourceURL=webpack-internal` comment\n          workerSource = workerSource.replace(sourceURLWebpackRegex, \"\");\n        }\n\n        const workerCode = workerGenerator(\n          loaderContext,\n          workerFilename,\n          workerSource,\n          options\n        );\n        const workerCodeBuffer = Buffer.from(workerCode);\n\n        return cache.store(\n          cacheIdent,\n          cacheETag,\n          workerCodeBuffer,\n          (storeCacheError) => {\n            if (storeCacheError) {\n              return callback(storeCacheError);\n            }\n\n            return callback(null, workerCodeBuffer);\n          }\n        );\n      });\n    }\n\n    return callback(\n      new Error(\n        `Failed to compile web worker \"${workerContext.request}\" request`\n      )\n    );\n  });\n}\n"],"mappings":";;;;;;AAAA,IAAAA,MAAA,GAAAC,OAAA;AAMe,SAASC,UAAUA,CAChCC,aAAa,EACbC,aAAa,EACbC,OAAO,EACPC,QAAQ,EACR;EACAF,aAAa,CAACG,QAAQ,CAACL,UAAU,CAAC,CAACM,KAAK,EAAEC,OAAO,EAAEC,WAAW,KAAK;IACjE,IAAIF,KAAK,EAAE;MACT,OAAOF,QAAQ,CAACE,KAAK,CAAC;IACxB;IAEA,IAAIC,OAAO,CAAC,CAAC,CAAC,EAAE;MACd,MAAM,CAACE,cAAc,CAAC,GAAG,CAAC,GAAGF,OAAO,CAAC,CAAC,CAAC,CAACG,KAAK,CAAC;MAC9C,MAAMC,KAAK,GAAGT,aAAa,CAACG,QAAQ,CAACO,QAAQ,CAAC,eAAe,CAAC;MAC9D,MAAMC,UAAU,GAAGJ,cAAc;MACjC,MAAMK,SAAS,GAAGH,KAAK,CAACI,iBAAiB,CACvCP,WAAW,CAACQ,MAAM,CAACP,cAAc,CACnC,CAAC;MAED,OAAOE,KAAK,CAACM,GAAG,CAACJ,UAAU,EAAEC,SAAS,EAAE,CAACI,aAAa,EAAEC,OAAO,KAAK;QAClE,IAAID,aAAa,EAAE;UACjB,OAAOd,QAAQ,CAACc,aAAa,CAAC;QAChC;QAEA,IAAIf,OAAO,CAACiB,MAAM,KAAK,aAAa,EAAE;UACpC;UACA,OAAOnB,aAAa,CAACoB,YAAY,CAACL,MAAM,CAACP,cAAc,CAAC;;UAExD;UACA;UACA,IAAIR,aAAa,CAACoB,YAAY,CAACL,MAAM,CAAE,GAAEP,cAAe,MAAK,CAAC,EAAE;YAC9D;YACA,OAAOR,aAAa,CAACoB,YAAY,CAACL,MAAM,CAAE,GAAEP,cAAe,MAAK,CAAC;UACnE;QACF;QAEA,IAAIU,OAAO,EAAE;UACX,OAAOf,QAAQ,CAAC,IAAI,EAAEe,OAAO,CAAC;QAChC;QAEA,IAAIG,YAAY,GAAGd,WAAW,CAACQ,MAAM,CAACP,cAAc,CAAC,CAACc,MAAM,CAAC,CAAC;QAE9D,IAAIpB,OAAO,CAACiB,MAAM,KAAK,aAAa,EAAE;UACpC;UACAE,YAAY,GAAGA,YAAY,CAACE,OAAO,CAACC,4BAAqB,EAAE,EAAE,CAAC;;UAE9D;UACAH,YAAY,GAAGA,YAAY,CAACE,OAAO,CAACE,4BAAqB,EAAE,EAAE,CAAC;QAChE;QAEA,MAAMC,UAAU,GAAG,IAAAC,sBAAe,EAChC3B,aAAa,EACbQ,cAAc,EACda,YAAY,EACZnB,OACF,CAAC;QACD,MAAM0B,gBAAgB,GAAGC,MAAM,CAACC,IAAI,CAACJ,UAAU,CAAC;QAEhD,OAAOhB,KAAK,CAACqB,KAAK,CAChBnB,UAAU,EACVC,SAAS,EACTe,gBAAgB,EACfI,eAAe,IAAK;UACnB,IAAIA,eAAe,EAAE;YACnB,OAAO7B,QAAQ,CAAC6B,eAAe,CAAC;UAClC;UAEA,OAAO7B,QAAQ,CAAC,IAAI,EAAEyB,gBAAgB,CAAC;QACzC,CACF,CAAC;MACH,CAAC,CAAC;IACJ;IAEA,OAAOzB,QAAQ,CACb,IAAI8B,KAAK,CACN,iCAAgChC,aAAa,CAACiC,OAAQ,WACzD,CACF,CAAC;EACH,CAAC,CAAC;AACJ"}