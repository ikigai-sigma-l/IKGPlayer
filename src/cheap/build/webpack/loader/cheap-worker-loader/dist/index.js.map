{"version":3,"file":"index.js","names":["_path","_interopRequireDefault","require","_loaderUtils","_schemaUtils","_NodeTargetPlugin","_SingleEntryPlugin","_WebWorkerTemplatePlugin","_ExternalsPlugin","_options","_supportWebpack","_supportWebpack2","_utils","obj","__esModule","default","FetchCompileWasmPlugin","FetchCompileAsyncWasmPlugin","useWebpack5","version","startsWith","getModifiedModules","userRequest","startIndex","lastIndexOf","substring","replace","loader","pitch","request","cacheable","options","getOptions","chunkFilename","name","filename","workerContext","compilerOptions","_compiler","getDefaultFilename","output","getDefaultChunkFilename","publicPath","globalObject","compiler","_compilation","createChildCompiler","WebWorkerTemplatePlugin","apply","target","NodeTargetPlugin","mangleImports","optimization","mangleWasmImports","externals","ExternalsPlugin","getExternalsType","SingleEntryPlugin","context","path","parse","resourcePath","cb","async","hooks","compilation","tap","tapCallback","_","normalModule","moduleRequest","resolve","loaders","push","type","point","NormalModule","webpack","isNormalModuleAvailable","getCompilationHooks","beforeLoaders","normalModuleLoader","cache","get","supportWebpack5","supportWebpack4"],"sourceRoot":"../../src/cheap/build/webpack/cheap-worker-loader/src","sources":["../src/index.js"],"sourcesContent":["import path from \"path\";\n\nimport { getOptions } from \"loader-utils\";\nimport { validate } from \"schema-utils\";\n\nimport NodeTargetPlugin from \"webpack/lib/node/NodeTargetPlugin\";\nimport SingleEntryPlugin from \"webpack/lib/SingleEntryPlugin\";\nimport WebWorkerTemplatePlugin from \"webpack/lib/webworker/WebWorkerTemplatePlugin\";\nimport ExternalsPlugin from \"webpack/lib/ExternalsPlugin\";\n\nimport schema from \"./options.json\";\nimport supportWebpack5 from \"./supportWebpack5\";\nimport supportWebpack4 from \"./supportWebpack4\";\nimport {\n  getDefaultFilename,\n  getDefaultChunkFilename,\n  getExternalsType,\n} from \"./utils\";\n\n\nlet FetchCompileWasmPlugin;\nlet FetchCompileAsyncWasmPlugin;\n\n// determine the version of webpack peer dependency\n// eslint-disable-next-line global-require, import/no-unresolved\nconst useWebpack5 = require(\"webpack/package.json\").version.startsWith(\"5.\");\n\nif (useWebpack5) {\n  // eslint-disable-next-line global-require, import/no-unresolved\n  FetchCompileWasmPlugin = require(\"webpack/lib/web/FetchCompileWasmPlugin\");\n  // eslint-disable-next-line global-require, import/no-unresolved\n  FetchCompileAsyncWasmPlugin = require(\"webpack/lib/web/FetchCompileAsyncWasmPlugin\");\n} else {\n  // eslint-disable-next-line global-require, import/no-unresolved, import/extensions\n  FetchCompileWasmPlugin = require(\"webpack/lib/web/FetchCompileWasmTemplatePlugin\");\n}\n\nfunction getModifiedModules(userRequest) {\n  const startIndex =\n  userRequest.lastIndexOf('!') === -1\n    ? 0\n    : userRequest.lastIndexOf('!') + 1;\n\n  return userRequest\n    .substring(startIndex)\n    .replace(/\\\\/g, '/');\n}\n\nexport default function loader() {}\n\nexport function pitch(request) {\n\n  this.cacheable(false);\n\n  const options = getOptions(this);\n\n  options.chunkFilename = `[id].[contenthash].${options.name}.js`;\n  options.filename = `${options.name}.js`;\n\n  // validate(schema, options, {\n  //   name: \"Worker Loader\",\n  //   baseDataPath: \"options\",\n  // });\n\n  const workerContext = {};\n  const compilerOptions = this._compiler.options || {};\n  const filename = options.filename\n    ? options.filename\n    : getDefaultFilename(compilerOptions.output.filename);\n  const chunkFilename = options.chunkFilename\n    ? options.chunkFilename\n    : getDefaultChunkFilename(compilerOptions.output.chunkFilename);\n  const publicPath = options.publicPath\n    ? options.publicPath\n    : compilerOptions.output.publicPath;\n\n  workerContext.options = {\n    filename,\n    chunkFilename,\n    publicPath,\n    globalObject: \"self\",\n  };\n\n  workerContext.compiler = this._compilation.createChildCompiler(\n    `worker-loader ${request}`,\n    workerContext.options\n  );\n\n  new WebWorkerTemplatePlugin().apply(workerContext.compiler);\n\n  if (this.target !== \"webworker\" && this.target !== \"web\") {\n    new NodeTargetPlugin().apply(workerContext.compiler);\n  }\n\n  if (FetchCompileWasmPlugin) {\n    new FetchCompileWasmPlugin({\n      mangleImports: compilerOptions.optimization.mangleWasmImports,\n    }).apply(workerContext.compiler);\n  }\n\n  if (FetchCompileAsyncWasmPlugin) {\n    new FetchCompileAsyncWasmPlugin().apply(workerContext.compiler);\n  }\n\n  if (compilerOptions.externals) {\n    new ExternalsPlugin(\n      getExternalsType(compilerOptions),\n      compilerOptions.externals\n    ).apply(workerContext.compiler);\n  }\n\n  new SingleEntryPlugin(\n    this.context,\n    `!!${request}`,\n    path.parse(this.resourcePath).name\n  ).apply(workerContext.compiler);\n\n  workerContext.request = request;\n\n  const cb = this.async();\n\n  workerContext.compiler.hooks.compilation.tap('cheap-worker-loader', (compilation) => {\n    const tapCallback = (_, normalModule) => {\n      const moduleRequest = getModifiedModules(normalModule.userRequest || '');\n\n      if (moduleRequest !== getModifiedModules(request)) {\n        return;\n      }\n\n      const loader = require.resolve('./loader.js');\n\n      normalModule.loaders.push({\n        loader,\n        options: {\n          type: options.type,\n          point: options.point\n        }\n      });\n    };\n    const NormalModule = workerContext.compiler.webpack && workerContext.compiler.webpack.NormalModule;\n    const isNormalModuleAvailable = NormalModule && NormalModule.getCompilationHooks;\n\n    if (isNormalModuleAvailable) {\n      NormalModule.getCompilationHooks(compilation).beforeLoaders.tap(\n        'cheap-worker-loader',\n        tapCallback\n      );\n    } else {\n      compilation.hooks.normalModuleLoader.tap('cheap-worker-loader', tapCallback);\n    }\n  });\n\n  if (\n    workerContext.compiler.cache &&\n    typeof workerContext.compiler.cache.get === \"function\"\n  ) {\n    supportWebpack5(this, workerContext, options, cb);\n  } else {\n    supportWebpack4(this, workerContext, options, cb);\n  }\n}\n"],"mappings":"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"}